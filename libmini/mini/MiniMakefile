MMFILE	= MiniMakefile
MAKE	= make -f $(MMFILE)

SHELL	= sh

HDRS	= minicore minibase\
	  minicomplex minivec minimtx\
	  minidyna minigeom minisort ministring miniref

MODS	= mini miniOGL\
	  miniv3f miniv3d miniv4f miniv4d\
	  minimath minimpfp\
	  minitime miniio minidir minirgb minicrs\
	  ministub minitile miniload\
	  minicoord miniwarp minicam minianim\
	  minilayer miniterrain miniearth\
	  minicache minishader\
	  miniray ministrip\
	  minipoint minitext minisky miniglobe\
	  minitree minibrick minilod\
	  minimesh minibspt miniproj\
	  pnmbase pnmsample\
	  database datafill\
	  datacloud datacache datagrid\
	  datacalc dataparse\
	  lunascan lunaparse lunacode

VMODS	= viewerbase\
	  threadbase curlbase\
	  jpegbase pngbase zlibbase squishbase greycbase\
	  dataconv miniimg\
	  minipano

SRCS	= $(MODS:=.cpp)
OBJS	= $(MODS:=.o)

VSRCS	= $(VMODS:=.cpp)
VOBJS	= $(VMODS:=.o)

AR	= ar -crs

CP	= cp -rfp
LN	= ln -fs
RM	= rm -rf

ZIP	= zip -qr9

.SUFFIXES: .cpp

.cpp.o:
	$(COMPILER) $(OPTS) -I.. -c $*.cpp

trap:

all:	lib libsfx example viewer tools

lib:	$(OBJS)
	@-$(AR) libMini.a $(OBJS)

libsfx:	$(VOBJS)
	@-$(AR) libMiniSFX.a $(VOBJS)

example: lib
	$(COMPILER) $(OPTS) -I.. -o example example.cpp -L. -lMini $(LINK) -lGL -lGLU -lm

stubtest: lib
	$(COMPILER) $(OPTS) -I.. -o stubtest stubtest.cpp -L. -lMini -lm

viewer:	lib libsfx
	$(COMPILER) $(OPTS) -I.. -o viewer viewer.cpp -L. -lMiniSFX -lMini $(LINK) -lGL -lGLU -lpthread -lcurl -ljpeg -lpng -lz -lm

depend:
	@-$(MAKEDEPEND) $(OPTS) -I.. $(SRCS) >$(MMFILE).d 2>/dev/null

vdepend: depend
	@-$(MAKEDEPEND) $(OPTS) -I.. $(VSRCS) >>$(MMFILE).d 2>/dev/null

install:
	@-echo "copying libraries to $(INSTALL)/lib"
	@-if [ ! -e $(INSTALL)/lib ]; then mkdir -p $(INSTALL)/lib; fi
	@-$(CP) libMini*.a $(INSTALL)/lib
	@-echo "copying headers to $(INSTALL)/include/mini"
	@-if [ ! -e $(INSTALL)/include/mini ]; then mkdir -p $(INSTALL)/include/mini; fi
	@-$(CP) $(HDRS:=.h) $(MODS:=.h) $(VMODS:=.h) $(INSTALL)/include/mini
	@-echo "copying data to $(DATA)/mini"
	@-if [ ! -e $(DATA)/mini ]; then mkdir -p $(DATA)/mini; fi
	@-$(CP) data/* $(DATA)/mini

tools:	lib libsfx
	@-(cd tools; $(MAKE) all)

clean:
	@-$(RM) $(OBJS) $(VOBJS) ii_files
	@-(cd tools; $(MAKE) clean)

tidy:	clean
	@-$(RM) *~ $(MMFILE).d Debug* Release* *.ncb *.opt *.plg
	@-$(RM) CMakeCache.txt CMakeFiles Makefile cmake_install.cmake
	@-$(RM) libMini*.a example stubtest viewer
	@-(cd tools; $(MAKE) tidy)

zip:	tidy
	@-(cd ..; $(ZIP) mini/MINI.zip mini -x \*/.\?\?\* -x \*CVS/\*)

sinclude $(MMFILE).d
